//
//  bootstrap.c
//  electra
//  modified slighty by Marcel C (pwned4ever) 01/09/2018
//  Created by Jamie Bishop on 11/02/2018.
//  Copyright Â© 2018 Electra Team. All rights reserved.
//

#include "bootstrap.h"
#include "file_utils.h"
#include "electra_objc.h"
#include "amfi_utils.h"
#include "utils.h"
#include <sys/stat.h>
#include <sys/wait.h>
#include <sys/fcntl.h>
#include <unistd.h>
#include <spawn.h>

#define tar "/electra/tar"
#define uicache "/electra/uicache"

pid_t pd;

void copy_tar() {
    extractGz("tar", "/electra/tar");
    chmod(tar, 0755);
    inject_trusts(1, (const char **)&(const char*[]){tar});
}

void copy_basebinaries() {
    
    
    
    // Remove old base binaries
    ///removing any left over files or conflicting files on the system
    unlink("/electra/jailbreakd");
    unlink("/electra/jailbreakd_client");
    unlink("/electra/libjailbreak.dylib");
    
    unlink("/electra/amfid_payload.dylib");
    unlink("/electra/inject_ctriticald");
    unlink("/electra/pspawn_payload.dylib");
    
    unlink("/electra/createSnapshot");
    unlink("/electra/createSystemSnapshot");
    unlink("/electra/helloworld");
    unlink("/electra/ldrestart");
    posix_spawn(&pd, "/electra/rm", NULL, NULL, (char **)&(const char*[]){ "rm", "-rdvf", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    ///removing any conflicting files on the system from unc0ver jb. i will be testing to add this dir to the jailbreak and possibly remove this call in an update. or not. depedns on functionality, or if needed to be cleaned and reextracted every re JB.
    posix_spawn(&pd, "/electra/rm", NULL, NULL, (char **)&(const char*[]){ "rm", "-rdvf", "/jb", NULL }, NULL);
    waitpid(pd, NULL, 0);
    //get rid of whole folder instead of specifc files left in electra root - to clean any conflicts on rejailbreaking
    unlink("/electra");
    unlink("/jb");
    mkdir("/electra", 0755);
    
    printf("copying tar binary...");
    
    copy_tar();
    printf("Running tar...\n");
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("basebinaries.tar"), "-C", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("amfid_payload.tar"), "-C", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    
    //posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("jailbreakd.tar"), "-C", "/electra", NULL }, NULL);
    // waitpid(pd, NULL, 0);
    
    //posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("libjailbreak.tar"), "-C", "/electra", NULL }, NULL);
    //waitpid(pd, NULL, 0);
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("pspawn_hook.tar"), "-C", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("rsync.tar"), "-C", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("spawn.tar"), "-C", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    
    
    printf("[bootstrapper] copied the required binaries into the right places\n");
    inject_trusts(4, (const char **)&(const char*[]){
        "/electra/inject_criticald",
        "/electra/amfid_payload.dylib",
        "/electra/pspawn_payload.dylib",
        "/electra/libjailbreak.dylib"
    });
    //extract gzipped files into electra dir as tar files
    extractGz("com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb","/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb");
    chmod("/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb", 0755);
    extractGz("p7zip_16.02_iphoneos-arm.deb","/electra/p7zip_16.02_iphoneos-arm.deb");
    chmod("/electra/p7zip_16.02_iphoneos-arm.deb", 0755);
    extractGz("unrar_5.5.8_iphoneos-arm.deb","/electra/unrar_5.5.8_iphoneos-arm.deb");
    chmod("/electra/unrar_5.5.8_iphoneos-arm.deb", 0755);
    extractGz("unzip_6.0_iphoneos-arm.deb","/electra/unzip_6.0_iphoneos-arm.deb");
    chmod("/electra/unzip_6.0_iphoneos-arm.deb", 0755);
    extractGz("zip_3.0_iphoneos-arm.deb","/electra/zip_3.0_iphoneos-arm.deb");
    chmod("/electra/zip_3.0_iphoneos-arm.deb", 0755);
    extractGz("rm","/electra/rm");
    chmod("/electra/rm", 0755);
    
    extractGz("ElecTh0rRemover1.0.sh","/electra/ElecTh0rRemover1.0.sh");
    chmod("/electra/ElecTh0rRemover1.0.sh", 0777);
    chown("/electra/ElecTh0rRemover1.0.sh", 0, 0);
    extractGz("uicache", "/electra/uicache");
    chmod(uicache, 0755);
    
}

void extract_bootstrap() {
    unlink("/bin/launchctl");
    extractGz("launchctl", "/electra/launchctl");
    cp("/bin/launchctl", "/electra/launchctl");
    chmod("/bin/launchctl", 0755);
    unlink("/electra/launchctl");
    
    int bootstrapped = open("/.bootstrapped_Th0r", O_RDONLY);
    if (bootstrapped != -1) {
        ///removing any left over files littered onto the system
        unlink("/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb.gz");
        unlink("/electra/zip_3.0_iphoneos-arm.deb.gz");
        unlink("/electra/unzip_6.0_iphoneos-arm.deb.gz");
        unlink("/electra/unrar_5.5.8_iphoneos-arm.deb.gz");
        unlink("/electra/p7zip_16.02_iphoneos-arm.deb.gz");
        unlink("/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb");
        
        unlink("/electra/zip_3.0_iphoneos-arm.deb");
        unlink("/electra/unzip_6.0_iphoneos-arm.deb");
        unlink("/electra/unrar_5.5.8_iphoneos-arm.deb");
        unlink("/electra/p7zip_16.02_iphoneos-arm.deb");
        unlink("/electra/ETJBR1134only.sh");
        unlink("/electra/killall.gz");
        unlink("/electra/uicache.gz");
        close(bootstrapped);
        return post_bootstrap(false);
    }
    close(bootstrapped);
    installingCydia();
    //extract new gzipped bootstrap to electra directory as a tar file
    extractGz("pwnedstrap.tar", "/electra/pwnedstrap.tar");
    //extract bootstrap tar file into / root  keep permissions and don't overwrite previously extracted - exact content/files/binaries or directories.  Display in xcode debug log
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "--preserve-permissions", "-xvkf", "/electra/pwnedstrap.tar", "-C", "/", NULL }, NULL);
    waitpid(pd, NULL, 0);
    
    
    char *myenviron[] = {
        "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/bin/X11:/usr/games",
        "PS1=\\h:\\w \\u\\$ ",
        NULL
    };
    ////just installing filza and it's dependancies. So anyne can hopefully fix any minor issue they may come across, in case they've forgotten to install filza and ran into a problem. They can now hopefullly fix it, if there cydia is not pening anymore but can open filza. In some cases you won't be able to open either, if you've messed up certain files from the jailbreak on your system.
    posix_spawn(&pd, "usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "usr/bin/dpkg", "-i", "/electra/p7zip_16.02_iphoneos-arm.deb", NULL }, (char **)&myenviron);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, "usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "usr/bin/dpkg", "-i", "/electra/unrar_5.5.8_iphoneos-arm.deb", NULL }, (char **)&myenviron);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, "usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "usr/bin/dpkg", "-i", "/electra/unzip_6.0_iphoneos-arm.deb", NULL },  (char **)&myenviron);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, "usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "usr/bin/dpkg", "-i", "/electra/zip_3.0_iphoneos-arm.deb", NULL },  (char **)&myenviron);
    waitpid(pd, NULL, 0);
    //after depends have been installed - install filza last.
    posix_spawn(&pd, "usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "usr/bin/dpkg", "-i", "/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb", NULL }, (char **)&myenviron);
    waitpid(pd, NULL, 0);
    ///removing any left over files littered onto the system
    unlink("/electra/snaprevert.deb");
    unlink("/electra/bootstrap.tar");
    unlink("/electra/pwnedstrap.tar");
    unlink("/electra/payload.tar");
    unlink("/electra/org.coolstar.tweakinject_1.0.7-2_iphoneos-arm.deb");
    unlink("/electra/com.ex.libsubstitute_0.0.7-coolstar_iphoneos-arm.deb");
    unlink("/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb");
    unlink("/electra/zip_3.0_iphoneos-arm.deb");
    unlink("/electra/unzip_6.0_iphoneos-arm.deb");
    unlink("/electra/unrar_5.5.8_iphoneos-arm.deb");
    unlink("/electra/p7zip_16.02_iphoneos-arm.deb");
    unlink("/electra/rollector.deb");
    
    unlink("/electra/snaprevert.deb.gz");
    unlink("/electra/com.ex.libsubstitute_0.0.7-coolstar_iphoneos-arm.deb.gz");
    unlink("/electra/com.tigisoftware.filza64bit_3.5.2-4_iphoneos-arm.deb.gz");
    unlink("/electra/zip_3.0_iphoneos-arm.deb.gz");
    unlink("/electra/unzip_6.0_iphoneos-arm.deb.gz");
    unlink("/electra/unrar_5.5.8_iphoneos-arm.deb.gz");
    unlink("/electra/p7zip_16.02_iphoneos-arm.deb.gz");
    unlink("/electra/rollector.deb.gz");
    //I noticed after jailbreaking my device with electra. I could never successfully connect to a facetime video call anymore, while in a jailbroken state. If i reboot and was in non JB state, video calls connected. A simple google search for the previous fix, revealed this easy forgotten fix from yalu mach_portal iirc. Tnx qwerty or whomever found out this fix. So i'd figured it should be added for anyone else that has had this issue after Jailbreaking. Instead of being done maunally through terminal. As the average user wouldn't know or do it and have broken facetime video calls. It may not happen or break for you, however it did for me from electra. So i added this...
    chmod("/var", 0777);
    chmod("/var/mobile", 0777);
    chmod("/var/mobile/Library", 0777);
    chmod("/var/mobile/Library/Preferences", 0777);
    
    FILE *file = fopen("/etc/hosts","w"); /* write file (create a file if it does not exist and if it does treat as empty.*/
    fprintf(file,"%s","##\n"); //writes
    fprintf(file,"%s","# Host Database\n"); //writes
    fprintf(file,"%s","# localhost is used to configure the loopback interface\n"); //writes
    fprintf(file,"%s","# when the system is booting.  Do not change this entry.\n"); //writes
    fprintf(file,"%s","##\n"); //writes
    fprintf(file,"%s","127.0.0.1    localhost\n"); //writes
    fprintf(file,"%s","255.255.255.255 broadcasthost\n"); //writes
    fprintf(file,"%s","::1      localhost\n"); //writes
    fclose(file); /*done!*/
    //removing unwanted sources// sorry coolstar - i have my own repo for main cydia debs. I'm also using bingners repo for other packages i haven't yet had time to add to my repo :) although it all works fine with Sam's repo Cheers and thanks Bingner:)
    
    int rv = open("/.bootstrapped_Th0r", O_RDWR|O_CREAT);
    close(rv);
    rv = open("/.cydia_no_stash",O_RDWR|O_CREAT);
    close(rv);
    
    chown("/usr/libexec/cydia/cydo", 0, 0);
    chmod("/usr/libexec/cydia/cydo", 04755);
    
    //chmod("/usr/bin/dpkg", 0755);
    
    printf("[bootstrapper] extracted bootstrap to / \n");
    
    post_bootstrap(true);
}

void post_bootstrap(const bool runUICache) {
    if (runUICache){
        int checkrvuicache =  posix_spawn(&pd, "/electra/uicache", NULL, NULL, (char **)&(const char*[]){ NULL, NULL, NULL, NULL }, NULL);
        waitpid(pd, NULL, 0);
        printf("Running UICACHE ? hopefully cydia & filza icon is there\n");
        printf("[*] Is uicache command running or not from electra folder %d=\n",checkrvuicache);
    }
    
    unlink(tar);
    
    unlink("/etc/apt/sources.list.d/electra.list");
    unlink("/etc/apt/sources.list.d/electra-shim.list");
    unlink("/etc/apt/sources.list.d/ricklantis.list");
    unlink("/etc/apt/sources.list.d/cydia.list");
    unlink("/etc/apt/sources.list.d/hbang.list");
    unlink("/etc/apt/sources.list.d/Th0r.list");
    unlink("/var/mobile/Library/Caches/com.saurik.Cydia/sources.list");
    FILE *file;
    file = fopen("/etc/apt/sources.list.d/Th0r.list","w"); /* write file (create a file if it does not exist and if it does treat as empty.*/
    fprintf(file,"%s","deb https://ricklantis.github.io/repo/ ./\n");
    fprintf(file,"%s","\n"); //writes
    fclose(file);
    
    unlink("/usr/lib/libjailbreak.dylib");
    cp("/usr/lib/libjailbreak.dylib","/electra/libjailbreak.dylib");
    
    inject_trusts(1, (const char **)&(const char*[]){"/bin/launchctl"});
    
    int rv = open("/var/lib/dpkg/available", O_RDWR|O_CREAT);
    close(rv);
    run("/usr/libexec/cydia/firmware.sh");
    run("/Library/dpkg/info/openssh.postinst");
    run("launchctl load /Library/LaunchDaemons/com.openssh.sshd.plist");
    
    chown("/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist",0, 80);
    printf("[bootstrapper] device has been bootstrapped!\n");
    
    if (runUICache){
        cydiaDone();
    }
}

